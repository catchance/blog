---
title: U盘安装grub2引导PE和LinuxLive
toc: true
tags:
  - 装机
  - grub
categories:
  - 工具
date: 2017-06-28 18:22:17 +08:00
---
> U盘安装grub2引导PE和LinuxLive

<!--more-->

### 实例
---
**准备：**
1. grub2
2. memdisk  

**环境：**
1. ubuntu 16.04/windows
2. iso镜像（win pe、linux）

#### 安装grub到U盘
- 分区  
    ```bash
    # windows下面使用DiskGenius进行分区，linux使用fdisk分区
    # 可以给U盘分三个区，第一个用来装iso文件，第二个分区用来实现kali live 的 persistence，第三个分区用来安装grub2
    # U盘为sdb盘
    $ df -l  # 查看挂在情况
    $ sudo fdisk -l # 查看磁盘情况
    $ sudo fdisk /dev/sdb
    Command (m for help): m        # 获取帮助
    Command (m for help): d        # delete the old partition(s)  
    Command (m for help): n        # create new partition(s)
    p  # 选择主分区
    Partition number (1-4): 1  #第一个分区
    First cylinder (1-487, default 1): 2048
    Last cylinder or +size or +sizeM or +sizeK (1-487, default 487): 24559615
    Command (m for help): n        # create new partition(s)
    p  # 选择主分区
    Partition number (1-4): 2  #第一个分区
    First cylinder (1-487, default 1): 24559616
    Last cylinder or +size or +sizeM or +sizeK (1-487, default 487): 30900223
    Command (m for help): n        # create new partition(s)
    p  # 选择主分区
    Partition number (1-4): 3  #第一个分区
    First cylinder (1-487, default 1): 30900224
    Last cylinder or +size or +sizeM or +sizeK (1-487, default 487):
    Command (m for help): w        # 提交修改并退出  
    ```
- 格式化分区
  ```bash
  $ mount /mnt/sb3 /dev/sdb3 #挂在分区
  $ umount /dev/sdb3 # 要格式化应先卸载分区
  # 格式化分区1为NTFS
  $ mkfs.ntfs -L data /dev/sdb1
  # 格式化分区2为ext4
  $ mkfs.ext4 -L persistence  /dev/sdb2
  # 格式化分区3为ext4
  $ mkfs.ext4 -L grub /dev/sdb3
  ```
- 激活可引导分区（否则不能引导）
  ```bash
  $ fdisk /dev/sdb  
  Command (m for help): a  
  Partition number (1-4): 3    # /dev/sdb3作为可引导分区
  Command (m for help): w
  ```
- grub-install安装
  ```bash
  $ df -l # 查看sdb3是否挂载，如果没有挂载则挂载
  $ mount /mnt/sdb3 /dev/sdb3
  # 安装grub2到U盘
  $ grub-install --boot-directory=/media/disk --no-floppy --force /dev/sdb3
  ```

#### 镜像文件  
将各种需要启动的镜像文件放入U盘第一分区data分区中去，由于引导winpe所以需要memdisk程序，也要拷入到U盘
|--boot
|  |--memdisk
|  |--kali.iso
|  |--ubuntu.iso
|  |--Ton8PE_V4.0.iso
|  |--Ton8PE_V4.0.iso
|  |--UQi_USBsys_9th.iso
|--tools
|  |--相关工具

#### Kali Live persistence的制作
- 从U盘启动Kali
- Live Persistence mode
- 进入kali桌面后 打开命令行，输入gparted 可以进行分区，如果提前分区好的话，就不需要在分区了。
- 配置 persistence
  ```bash
  $ mkdir /mnt/usb
  $ mount /dev/sdb2 /mnt/usb
  $ echo "/ union" >> /mnt/usb/persistence.conf
  $ umount /mnt/usb
  ```
#### grub.cfg示例
grub.cfg的配置文件需要放入U盘中安装grub2的第三个分区grub分区  

```bash
#
# DO NOT EDIT THIS FILE
#
# It is automatically generated by grub-mkconfig using templates
# from /etc/grub.d and settings from /etc/default/grub
# grub.cfg 默认为只读，要修改前先设为可写 sudo chmod +w /boot/grub/grub.cfg
#

# 设置超时时间
set timeout=10

# 默认启动第一个菜单项
set default=0

# kali
submenu "Kali Linux" {

    set root='(hd0,msdos1)'
    set isofile="/boot/kali.iso"
    loopback loop $isofile

    # Live boot
    menuentry 'Kali Linux' {
      linux (loop)/live/vmlinuz findiso=$isofile boot=live noconfig=sudo username=root hostname=kali noswap
      initrd (loop)/live/initrd.img
    }

    menuentry "Live system" {
      linux (loop)/live/vmlinuz-4.9.0-kali3-amd64 findiso=$isofile boot=live components splash username=root hostname=kali
      initrd  (loop)/live/initrd.img-4.9.0-kali3-amd64
    }

    menuentry "Live system (fail-safe mode)" {
      linux (loop)/live/vmlinuz-4.9.0-kali3-amd64 findiso=$isofile boot=live components username=root hostname=kali memtest noapic noapm nodma nomce nolapic nomodeset nosmp nosplash vga=normal
      initrd  (loop)/live/initrd.img-4.9.0-kali3-amd64
    }

    menuentry "Live system (forensic mode)" {
      linux (loop)/live/vmlinuz-4.9.0-kali3-amd64 findiso=$isofile boot=live components splash username=root hostname=kali noswap noautomount
      initrd (loop)/live/initrd.img-4.9.0-kali3-amd64
    }

    menuentry "Live system (persistence, check kali.org/prst)" {
      linux (loop)/live/vmlinuz-4.9.0-kali3-amd64 findiso=$isofile boot=live components splash username=root hostname=kali persistence
      initrd (loop)/live/initrd.img-4.9.0-kali3-amd64
    }

    menuentry "Live system (encrypted persistence, check kali.org/prst)" {
      linux (loop)/live/vmlinuz-4.9.0-kali3-amd64 findiso=$isofile boot=live components splash username=root hostname=kali persistent=cryptsetup persistence-encryption=luks persistence
      initrd (loop)/live/initrd.img-4.9.0-kali3-amd64
    }

    # Installer (if any)
    menuentry "Start installer" {
      linux (loop)/install/gtk/vmlinuz findiso=$isofile video=vesa:ywrap,mtrr vga=788 quiet
      initrd  (loop)/install/gtk/initrd.gz
    }

    menuentry "Start installer with speech synthesis" {
      linux (loop)/install/gtk/vmlinuz findiso=$isofile speakup.synth=soft video=vesa:ywrap,mtrr vga=788 quiet
      initrd (loop)/install/gtk/initrd.gz
    }

    # Memtest (if any)
    menuentry "memtest86" {
      linux16 (loop)/live/memtest
    }

}


# win pe
submenu "Win PE" {

    set root='(hd0,msdos1)'
    echo 'Loading Memdisk...'
    insmod memdisk

    menuentry 'Win PE(116M)' {
       	linux16 /boot/memdisk iso raw
        echo 'Loading ISO...'
      	initrd16 /boot/Ton8PE_V4.0.iso
    }

    menuentry 'Win PE(756M)' {
        linux16 /boot/memdisk iso raw
        echo 'Loading ISO...'
        initrd16 /boot/UQi_USBsys_9th.iso
    }

}

# ubuntu

submenu "Ubuntu" {

    set root='(hd0,msdos1)'
    set isofile="/boot/ubuntu.iso"
    loopback loop $isofile

    menuentry "Try Ubuntu Kylin without installing" {
      set gfxpayload=keep
      linux (loop)/casper/vmlinuz.efi locale=zh_CN keyboard-configuration/layoutcode?=cn file=/cdrom/preseed/ubuntu.seed boot=casper iso-scan/filename=${isofile} quiet splash ---
      initrd (loop)/casper/initrd.lz
    }
    menuentry "Install Ubuntu Kylin" {
      set gfxpayload=keep
      linux (loop)/casper/vmlinuz.efi locale=zh_CN keyboard-configuration/layoutcode?=cn file=/cdrom/preseed/ubuntu.seed boot=casper iso-scan/filename=${isofile} only-ubiquity quiet splash ---
      initrd (loop)/casper/initrd.lz
    }
}

#本地磁盘启动
menuentry "Boot HDD(hd1)" {
  set root=(hd1)
  chainloader +1
}

menuentry "搜索windows的bootmgr启动" {
    search --file /bootmgr --set=root
    chainloader +1
}

#重启
menuentry "Reboot" {
  reboot
}

#关机
menuentry "Shutdown" {
  halt
}
```

### 技巧
---
- 相关grub的配置项可以从Linux Live中的grub配置项提取出来
- memdisk可以从linux系统中直接copy出来用
- Kali Linux 注意 `findiso=$isofile`配置


### 文献
---
- [GNU GRUB官网](http://www.gnu.org/software/grub/)
- [Grub2的一些典型菜单写法](http://blog.csdn.net/Listener_ri/article/details/50583804)
- [grub2多重引导U盘](http://bbs.archlinuxcn.org/viewtopic.php?pid=20804)
- [安装grub到U盘](http://blog.csdn.net/duyiwuer2009/article/details/7799687)
- [GRUB2配置文件"grub.cfg"详解(GRUB2实战手册)](http://www.jinbuguo.com/linux/grub.cfg.html)
- [基于Kali Live模式下的Persistence功能加载总结](http://www.kali.org.cn/thread-18549-1-1.html)
