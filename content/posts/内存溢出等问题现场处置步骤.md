+++
title = "内存溢出等问题现场处置步骤"
description = "description"
keywords = ["java", "oom"]
categories = ["java"]
tags = ["java"]
date = 2019-09-18T19:27:06+08:00
draft = true
# CJKLanguage: Chinese, Japanese, Korean
isCJKLanguage = true
# 排序你的文章
weight = 40

# 这里还可以自定义任何参数，这些参数可以在模板中使用
toc = true
comments = false
# 精选图片
featured_image = ""
+++

> 内存溢出等问题现场处置步骤
<!--more-->

### 保存现场
---
在遇到现实服务器实例报OOM错误时 尽量按以下步骤保留现场信息 方便后续定位

#### 获取进程号
jps -v|grep 关键字

#### 创建事故现网文件夹
mkdir {pid}

#### 查看磁盘空间是否打满
df -h >{pid}/df_h.txt 

#### 查看内存空间是否打满
free -m >{pid}/free_m.txt 

#### 查看io
iostat -d -k 1 10 >{pid}/io.txt 

#### 查看cpu等其它信息（兜底包含其它信息）
top -M -n 2 -d 3 >{pid}/top.txt 查看top

#### 查看是否一直fullgc
jstat -gcutil {pid} 1000 1000 > {pid}/jstat_gcutil.txt 

#### 得到存活内存分布图
jmap -histo:live {pid} >{pid}/jmap_histo.txt 

#### dump当前线程栈到对应文件
jmap -dump:live,file={pid}/jmap_dum {pid} 

#### 堆快照
jstack {pid} >{pid}/jstack_1.txt 一次堆栈快照 备用
jstack {pid} >{pid}/jstack_2.txt 两次堆栈快照 备用

### 脚本
- 简单命令

``` bash
mkdir {pid};
df -h >{pid}/df_h.txt;
free -m >{pid}/free_m.txt
iostat -d -k 1 10 >{pid}/io.txt ;
jstat -gcutil {pid} > {pid}/jstat_gcutil.txt ;
jmap -histo:live {pid} >{pid}/jmap_histo.txt ;
jmap -dump:live,file={pid}/jmap_dum {pid} ;
jstack {pid} >{pid}/jstack_1.txt;
jstack {pid} >{pid}/jstack_2.txt ;
top -M -n 1 >{pid}/top.txt ;
```
- dump脚本示例

``` bash
JAVA_HOME=/usr/java  
OUTPUT_HOME=~/output  
DEPLOY_HOME=`dirname $0`  
HOST_NAME=`hostname`  
  
DUMP_PIDS=`ps  --no-heading -C java -f --width 1000 | grep "$DEPLOY_HOME" |awk '{print $2}'`  
if [ -z "$DUMP_PIDS" ]; then  
    echo "The server $HOST_NAME is not started!"  
    exit 1;  
fi  
  
DUMP_ROOT=$OUTPUT_HOME/dump  
if [ ! -d $DUMP_ROOT ]; then  
    mkdir $DUMP_ROOT  
fi  
  
DUMP_DATE=`date +%Y%m%d%H%M%S`  
DUMP_DIR=$DUMP_ROOT/dump-$DUMP_DATE  
if [ ! -d $DUMP_DIR ]; then  
    mkdir $DUMP_DIR  
fi  
  
echo -e "Dumping the server $HOST_NAME ...\c"  
for PID in $DUMP_PIDS ; do  
    $JAVA_HOME/bin/jstack $PID > $DUMP_DIR/jstack-$PID.dump 2>&1  
    echo -e ".\c"  
    $JAVA_HOME/bin/jinfo $PID > $DUMP_DIR/jinfo-$PID.dump 2>&1  
    echo -e ".\c"  
    $JAVA_HOME/bin/jstat -gcutil $PID > $DUMP_DIR/jstat-gcutil-$PID.dump 2>&1  
    echo -e ".\c"  
    $JAVA_HOME/bin/jstat -gccapacity $PID > $DUMP_DIR/jstat-gccapacity-$PID.dump 2>&1  
    echo -e ".\c"  
    $JAVA_HOME/bin/jmap $PID > $DUMP_DIR/jmap-$PID.dump 2>&1  
    echo -e ".\c"  
    $JAVA_HOME/bin/jmap -heap $PID > $DUMP_DIR/jmap-heap-$PID.dump 2>&1  
    echo -e ".\c"  
    $JAVA_HOME/bin/jmap -histo $PID > $DUMP_DIR/jmap-histo-$PID.dump 2>&1  
    echo -e ".\c"  
    if [ -r /usr/sbin/lsof ]; then  
    /usr/sbin/lsof -p $PID > $DUMP_DIR/lsof-$PID.dump  
    echo -e ".\c"  
    fi  
done  
if [ -r /usr/bin/sar ]; then  
/usr/bin/sar > $DUMP_DIR/sar.dump  
echo -e ".\c"  
fi  
if [ -r /usr/bin/uptime ]; then  
/usr/bin/uptime > $DUMP_DIR/uptime.dump  
echo -e ".\c"  
fi  
if [ -r /usr/bin/free ]; then  
/usr/bin/free -t > $DUMP_DIR/free.dump  
echo -e ".\c"  
fi  
if [ -r /usr/bin/vmstat ]; then  
/usr/bin/vmstat > $DUMP_DIR/vmstat.dump  
echo -e ".\c"  
fi  
if [ -r /usr/bin/mpstat ]; then  
/usr/bin/mpstat > $DUMP_DIR/mpstat.dump  
echo -e ".\c"  
fi  
if [ -r /usr/bin/iostat ]; then  
/usr/bin/iostat > $DUMP_DIR/iostat.dump  
echo -e ".\c"  
fi  
if [ -r /bin/netstat ]; then  
/bin/netstat > $DUMP_DIR/netstat.dump  
echo -e ".\c"  
fi  
echo "OK!"
```

### 重启
---
重启相关服务

### 相关文档
---


